<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>EV Maximizer - Terminale Operativo</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        :root { --neon: #33c95c; --bg: #050505; --card-bg: #0f0f0f; --cyan: #00e5ff; }
        body { background: var(--bg); color: white; font-family: 'Share Tech Mono', monospace; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 300px; background: #000; border-right: 1px solid #1a1a1a; padding: 25px; display: flex; flex-direction: column; }
        .main-content { flex-grow: 1; padding: 40px; overflow-y: auto; }
        .card { background: var(--card-bg); border: 1px solid #1a1a1a; padding: 25px; position: relative; }
        
        /* Nuovi elementi per lo stato di importazione */
        #import-console { 
            background: #000; border: 1px solid #1a1a1a; height: 100px; 
            overflow-y: auto; font-size: 10px; color: var(--neon); padding: 10px; margin-top: 10px;
            display: none;
        }
        .progress-bar-container { width: 100%; height: 5px; background: #1a1a1a; margin-top: 5px; display: none; }
        #progress-fill { height: 100%; background: var(--neon); width: 0%; transition: 0.3s; }
        
        .btn-refresh { 
            background: transparent; border: 1px solid var(--neon); color: var(--neon); 
            padding: 5px 15px; cursor: pointer; font-family: 'Orbitron'; font-size: 10px;
        }
        .btn-refresh:hover { background: var(--neon); color: #000; }
        .graph-container { grid-column: span 3; height: 400px; background: #000; margin-top: 20px; padding: 20px; }
    </style>
</head>
<body onload="initDashboard()">

    <div class="sidebar">
        <div style="margin-bottom: 50px;">
            <div class="orbitron" style="font-size: 16px; color: var(--neon);">EV_MAXIMIZER</div>
        </div>
        <nav style="flex-grow: 1;">
            <div class="nav-item active">> DASHBOARD</div>
            <div class="nav-item" onclick="location.href='sessions.html'">> MY SESSIONS</div>
            <div class="nav-item" onclick="location.href='evo.html'">> EVO COACH</div>
        </nav>
    </div>

    <div class="main-content">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <div class="orbitron" style="font-size: 24px;">SYSTEM_DASHBOARD</div>
            <button class="btn-refresh" onclick="loadDataFromDB()">FORCE_DB_REFRESH</button>
        </div>

        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
            <div class="card">
                <div style="font-size: 10px; color: #444;">DATABASE_SYNC_STATUS</div>
                <div id="sync-status" style="color: var(--neon); margin-top: 10px;">CONNECTED</div>
            </div>

            <div class="card" id="drop-zone" style="border: 2px dashed #333; cursor: pointer;">
                <div style="font-size: 10px; color: var(--cyan);">IMPORT_ZONE (HH_FILES)</div>
                <div style="font-size: 11px; color: #666; margin-top: 5px;">DRAG FILES HERE OR CLICK</div>
                <div class="progress-bar-container" id="p-container"><div id="progress-fill"></div></div>
            </div>

            <div class="card">
                <div style="font-size: 10px; color: #444;">TOTAL_PROFIT</div>
                <div id="total-profit" style="font-size: 24px; color: #fff;">€ 0.00</div>
            </div>
        </div>

        <div id="import-console"></div>

        <div class="graph-container">
            <canvas id="performanceChart"></canvas>
        </div>
    </div>

    <script>
        // URL del tuo database (Google Apps Script)
        const DB_URL = "https://script.google.com/macros/s/AKfycbwp-Y8FVTO6wJFbhZ-Pma-_9fU-4lu3zWSbXrlFd4qDZ9Qt8KB46zs8c1Hws64GEWx7BQ/exec";
        let perfChart;

        function initDashboard() {
            initChart();
            loadDataFromDB(); // Carica subito i dati salvati
        }

        function initChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            perfChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Net', data: [], borderColor: '#33c95c', borderWidth: 2, pointRadius: 0 },
                        { label: 'EV', data: [], borderColor: '#00e5ff', borderDash: [5,5], borderWidth: 2, pointRadius: 0 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        async function loadDataFromDB() {
            logConsole("Inizializzando recupero dati dal Database...");
            try {
                const response = await fetch(DB_URL + "?action=getSessions");
                const data = await response.json();
                updateUIWithDBData(data);
                logConsole("Dati caricati correttamente.");
            } catch (e) {
                logConsole("ERRORE: Impossibile connettersi al database.");
            }
        }

        function logConsole(msg) {
            const consoleBox = document.getElementById('import-console');
            consoleBox.style.display = 'block';
            consoleBox.innerHTML += `> ${new Date().toLocaleTimeString()}: ${msg}<br>`;
            consoleBox.scrollTop = consoleBox.scrollHeight;
        }

        // Logica di importazione file
        const dropZone = document.getElementById('drop-zone');
        dropZone.ondrop = async (e) => {
            e.preventDefault();
            const files = Array.from(e.dataTransfer.files);
            logConsole(`Rilevati ${files.length} file. Inizio importazione...`);
            
            document.getElementById('p-container').style.display = 'block';
            let processed = 0;

            for (let file of files) {
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    // Invia a Python per il parsing, poi Python invierà al Database
                    await fetch('http://127.0.0.1:5000/upload-hand', { method: 'POST', body: formData });
                    processed++;
                    let percent = (processed / files.length) * 100;
                    document.getElementById('progress-fill').style.width = percent + "%";
                } catch (err) {
                    logConsole(`Errore su file: ${file.name}`);
                }
            }
            
            logConsole("Importazione completata. Aggiornamento Dashboard...");
            setTimeout(loadDataFromDB, 2000); // Ricarica i dati dal DB dopo l'importazione
        };

        dropZone.ondragover = (e) => e.preventDefault();

        function updateUIWithDBData(sessions) {
            if (!sessions || sessions.length === 0) return;
            
            let netData = [0], evData = [0], labels = [0], total = 0;
            
            sessions.forEach((s, index) => {
                total += parseFloat(s.profit);
                netData.push(total);
                evData.push(total * 0.95); // Qui poi useremo l'EV reale dal DB
                labels.push(index + 1);
            });

            perfChart.data.labels = labels;
            perfChart.data.datasets[0].data = netData;
            perfChart.data.datasets[1].data = evData;
            perfChart.update();
            
            document.getElementById('total-profit').innerText = `€ ${total.toFixed(2)}`;
        }
    </script>
</body>
</html>