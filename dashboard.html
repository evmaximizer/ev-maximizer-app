<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>EV Maximizer - Dashboard</title>
    <link rel="icon" type="image/png" href="logotop.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root { --neon: #33c95c; --bg: #050505; --card-bg: #0f0f0f; --cyan: #00e5ff; --orange: #ffaa00; }
        body { background: var(--bg); color: white; font-family: 'Share Tech Mono', monospace; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 300px; background: #000; border-right: 1px solid #1a1a1a; padding: 25px; display: flex; flex-direction: column; }
        .nav-item { color: #666; margin-bottom: 15px; cursor: pointer; transition: 0.3s; font-family: 'Orbitron'; font-size: 11px; letter-spacing: 1px; }
        .nav-item:hover, .nav-item.active { color: var(--neon); text-shadow: 0 0 10px var(--neon); }
        .btn-logout { color: #ff4444 !important; margin-top: auto; border-top: 1px solid #1a1a1a; padding-top: 20px; }
        .main-content { flex-grow: 1; padding: 40px; overflow-y: auto; background: radial-gradient(circle at top right, #0a0a0a, #050505); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; border-bottom: 1px solid #1a1a1a; padding-bottom: 20px; }
        .pill { background: rgba(0,0,0,0.5); border: 1px solid #1a1a1a; padding: 8px 15px; border-radius: 4px; display: inline-flex; align-items: center; }
        .orbitron { font-family: 'Orbitron', sans-serif; font-weight: 900; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .card { background: var(--card-bg); border: 1px solid #1a1a1a; padding: 20px; position: relative; overflow: hidden; }
        .card::before { content: ""; position: absolute; top: 0; left: 0; width: 2px; height: 100%; background: var(--neon); }
        .card.cyan::before { background: var(--cyan); }
        .card.orange::before { background: var(--orange); }
        .graph-container { grid-column: span 4; height: 350px; background: #000; border: 1px solid #1a1a1a; padding: 20px; }
        .small-graph { grid-column: span 2; height: 250px; background: #000; border: 1px solid #1a1a1a; padding: 20px; margin-top: 10px; }
        select { background: transparent; color: var(--cyan); border: none; font-family: 'Orbitron'; font-size: 10px; outline: none; cursor: pointer; }
        #import-log { grid-column: span 4; background: #000; border: 1px solid #1a1a1a; font-size: 10px; color: var(--neon); padding: 10px; margin-bottom: 10px; }
    </style>
</head>
<body onload="initDashboard()">

    <div class="sidebar">
        <div style="margin-bottom: 50px;">
            <img src="logotop.png" style="width: 40px; filter: drop-shadow(0 0 5px var(--neon));">
            <div class="orbitron" style="font-size: 16px; margin-top: 10px; letter-spacing: 2px;">EV_MAXIMIZER</div>
        </div>
        <nav style="flex-grow: 1;">
            <div class="nav-item active" onclick="navigate('dashboard.html')">> DASHBOARD</div>
            <div class="nav-item" onclick="navigate('sessions.html')">> MY SESSIONS</div>
            <div class="nav-item" onclick="navigate('evo.html')">> EVO COACH (AI)</div>
            <div class="nav-item btn-logout" onclick="logout()">> LOGOUT</div>
        </nav>
    </div>

    <div class="main-content">
        <div class="header">
            <div class="orbitron" style="font-size: 20px;">SYSTEM_DASHBOARD</div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <button class="pill" style="color: var(--neon); cursor: pointer; background: none; border: 1px solid var(--neon);" onclick="loadDataFromDB()">SYNC_NOW</button>
                <div class="pill"><span id="user-display" style="font-size: 11px;">DR1V3R</span></div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <div class="orbitron" style="font-size: 9px; color: #444; margin-bottom: 10px;">TOTAL_NET_PROFIT</div>
                <div style="font-size: 24px; font-weight: 900;" id="total-profit">€ 0.00</div>
            </div>
            <div class="card cyan">
                <div class="orbitron" style="font-size: 9px; color: #444; margin-bottom: 10px;">AVERAGE_VPIP</div>
                <div style="font-size: 24px; font-weight: 900; color: var(--cyan);" id="avg-vpip">0.0%</div>
            </div>
            <div class="card orange">
                <div class="orbitron" style="font-size: 9px; color: #444; margin-bottom: 10px;">AVERAGE_PFR</div>
                <div style="font-size: 24px; font-weight: 900; color: var(--orange);" id="avg-pfr">0.0%</div>
            </div>
            <div class="card" style="border-left-color: #666;">
                <div class="orbitron" style="font-size: 9px; color: #444; margin-bottom: 10px;">STAKE_FILTER</div>
                <select id="buyin-filter" onchange="applyFilters()" style="font-size: 18px; width: 100%;">
                    <option value="ALL">ALL_STAKES</option>
                    <option value="5">€ 5.00</option>
                    <option value="10">€ 10.00</option>
                </select>
            </div>

            <div id="import-log">Database pronto.</div>

            <div class="graph-container">
                <div class="orbitron" style="font-size: 10px; color: var(--neon); margin-bottom: 10px;">NET_PROFIT_GRAPH</div>
                <canvas id="performanceChart"></canvas>
            </div>

            <div class="small-graph">
                <div class="orbitron" style="font-size: 10px; color: var(--cyan); margin-bottom: 10px;">VOLUME_TREND (HANDS)</div>
                <canvas id="volumeChart"></canvas>
            </div>
            <div class="small-graph">
                <div class="orbitron" style="font-size: 10px; color: var(--orange); margin-bottom: 10px;">PROFIT_DISTRIBUTION</div>
                <canvas id="stakePieChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        const DB_URL = "https://script.google.com/macros/s/AKfycbxDT81UDInmuccMGw-T44N8r_apnBTOQxTGlj6rhAU8AbAVuD3T94Q6ECezyiFPYOUZwg/exec";
        let perfChart, volumeChart, stakePieChart;
        let allData = [];

        function initDashboard() {
            initCharts();
            loadDataFromDB();
            setInterval(loadDataFromDB, 60000);
        }

        async function loadDataFromDB() {
            const user = "dr1v3r";
            const url = `${DB_URL}?action=getSessions&username=${encodeURIComponent(user)}`;
            document.getElementById('import-log').innerText = "SINCRONIZZAZIONE IN CORSO...";

            try {
                const r = await fetch(url);
                allData = await r.json();
                document.getElementById('import-log').innerText = "SYNC OK: " + allData.length + " SESSIONI";
                applyFilters();
            } catch (e) { 
                document.getElementById('import-log').innerText = "ERRORE CONNESSIONE";
            }
        }

        function initCharts() {
            // Grafico Lineare
            perfChart = new Chart(document.getElementById('performanceChart').getContext('2d'), {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Profit', data: [], borderColor: '#33c95c', fill: true, backgroundColor: 'rgba(51,201,92,0.1)', tension: 0.3 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            // Grafico Volume (Barre)
            volumeChart = new Chart(document.getElementById('volumeChart').getContext('2d'), {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'Hands', data: [], backgroundColor: 'rgba(0, 229, 255, 0.4)', borderColor: '#00e5ff', borderWidth: 1 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            // Grafico Stake (Pie)
            stakePieChart = new Chart(document.getElementById('stakePieChart').getContext('2d'), {
                type: 'doughnut',
                data: { labels: ['NL5', 'NL10'], datasets: [{ data: [0, 0], backgroundColor: ['#00e5ff', '#ffaa00'], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function applyFilters() {
            const stake = document.getElementById('buyin-filter').value;
            const filtered = (stake === "ALL") ? allData : allData.filter(s => parseFloat(s.buyin) === parseFloat(stake));
            updateUI(filtered);
        }

        function updateUI(sessions) {
            let total = 0, totalVpip = 0, totalPfr = 0, profitArray = [0], volumeArray = [], stakeData = { "5": 0, "10": 0 };

            sessions.forEach((s, i) => {
                let p = parseFloat(s.profit || 0);
                total += p;
                profitArray.push(total);
                volumeArray.push(s.hands || 0);
                totalVpip += parseFloat(s.vpip || 0);
                totalPfr += parseFloat(s.pfr || 0);
                if(s.buyin == 5) stakeData["5"] += p;
                if(s.buyin == 10) stakeData["10"] += p;
            });

            // Widget
            document.getElementById('total-profit').innerText = "€ " + total.toFixed(2);
            if(sessions.length > 0) {
                document.getElementById('avg-vpip').innerText = (totalVpip / sessions.length).toFixed(1) + "%";
                document.getElementById('avg-pfr').innerText = (totalPfr / sessions.length).toFixed(1) + "%";
            }

            // Update Charts
            perfChart.data.labels = Array.from(Array(profitArray.length).keys());
            perfChart.data.datasets[0].data = profitArray;
            perfChart.update();

            volumeChart.data.labels = sessions.map((_, i) => i + 1);
            volumeChart.data.datasets[0].data = volumeArray;
            volumeChart.update();

            stakePieChart.data.datasets[0].data = [Math.abs(stakeData["5"]), Math.abs(stakeData["10"])];
            stakePieChart.update();
        }

        function navigate(p) { window.location.href = p; }
        function logout() { localStorage.clear(); window.location.href = "index.html"; }
    </script>
</body>
</html>