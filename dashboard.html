<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>EV Maximizer - Terminale Operativo</title>
    <link rel="icon" type="image/png" href="logotop.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        :root { --neon: #33c95c; --bg: #050505; --card-bg: #0f0f0f; --cyan: #00e5ff; --orange: #ffaa00; }
        body { background: var(--bg); color: white; font-family: 'Share Tech Mono', monospace; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 300px; background: #000; border-right: 1px solid #1a1a1a; padding: 25px; display: flex; flex-direction: column; }
        .nav-item { color: #666; margin-bottom: 15px; cursor: pointer; transition: 0.3s; font-family: 'Orbitron'; font-size: 11px; letter-spacing: 1px; }
        .nav-item:hover, .nav-item.active { color: var(--neon); text-shadow: 0 0 10px var(--neon); }
        .btn-logout { color: #ff4444 !important; margin-top: auto; border-top: 1px solid #1a1a1a; padding-top: 20px; }
        .main-content { flex-grow: 1; padding: 40px; overflow-y: auto; background: radial-gradient(circle at top right, #0a0a0a, #050505); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; border-bottom: 1px solid #1a1a1a; padding-bottom: 20px; }
        .pill { background: rgba(0,0,0,0.5); border: 1px solid #1a1a1a; padding: 8px 15px; border-radius: 4px; display: inline-flex; align-items: center; }
        .orbitron { font-family: 'Orbitron', sans-serif; font-weight: 900; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; }
        .card { background: var(--card-bg); border: 1px solid #1a1a1a; padding: 20px; position: relative; overflow: hidden; }
        .card::before { content: ""; position: absolute; top: 0; left: 0; width: 2px; height: 100%; background: var(--neon); }
        .card.cyan::before { background: var(--cyan); }
        .card.orange::before { background: var(--orange); }
        .graph-container { grid-column: span 4; height: 350px; background: #000; border: 1px solid #1a1a1a; padding: 20px; margin-top: 10px; }
        select { background: transparent; color: var(--cyan); border: none; font-family: 'Orbitron'; font-size: 10px; outline: none; cursor: pointer; }
        #import-log { grid-column: span 4; background: #000; border: 1px solid #1a1a1a; height: 40px; overflow-y: auto; font-size: 10px; color: var(--neon); padding: 10px; margin-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
        th { text-align: left; color: #444; font-family: 'Orbitron'; padding: 10px; border-bottom: 1px solid #1a1a1a; }
        td { padding: 10px; border-bottom: 1px solid #080808; }
    </style>
</head>
<body onload="initDashboard()">

    <div class="sidebar">
        <div style="margin-bottom: 50px;">
            <img src="logotop.png" style="width: 40px; filter: drop-shadow(0 0 5px var(--neon));">
            <div class="orbitron" style="font-size: 16px; margin-top: 10px; letter-spacing: 2px;">EV_MAXIMIZER</div>
        </div>
        <nav id="sidebar-nav" style="flex-grow: 1;">
            <div class="nav-item active" onclick="navigate('dashboard.html')">> DASHBOARD</div>
            <div class="nav-item" onclick="navigate('sessions.html')">> MY SESSIONS</div>
            <div class="nav-item" onclick="navigate('evo.html')">> EVO COACH (AI)</div>
            <div class="nav-item btn-logout" onclick="logout()">> LOGOUT</div>
        </nav>
    </div>

    <div class="main-content">
        <div class="header">
            <div class="orbitron" style="font-size: 20px;">SYSTEM_DASHBOARD</div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <div class="pill" style="border-color: var(--cyan);">
                    <span style="font-size: 9px; color: #666; margin-right: 10px;">TOKENS:</span>
                    <span id="token-display" style="color: var(--cyan); font-weight: bold;">100</span>
                </div>
                <button class="pill" style="color: var(--neon); cursor: pointer; background: none; border: 1px solid var(--neon);" onclick="loadDataFromDB()">SYNC_NOW</button>
                <div class="pill">
                    <span id="user-display" style="font-size: 11px;">DR1V3R</span>
                </div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="card">
                <div class="orbitron" style="font-size: 9px; color: #444; margin-bottom: 10px;">NET_PROFIT</div>
                <div style="font-size: 24px; font-weight: 900;" id="total-profit">€ 0.00</div>
            </div>
            <div class="card cyan">
                <div class="orbitron" style="font-size: 9px; color: #444; margin-bottom: 10px;">AVG_VPIP</div>
                <div style="font-size: 24px; font-weight: 900; color: var(--cyan);" id="avg-vpip">0.0%</div>
            </div>
            <div class="card orange">
                <div class="orbitron" style="font-size: 9px; color: #444; margin-bottom: 10px;">AVG_PFR</div>
                <div style="font-size: 24px; font-weight: 900; color: var(--orange);" id="avg-pfr">0.0%</div>
            </div>
            <div class="card" style="border-left-color: #666;">
                <div class="orbitron" style="font-size: 9px; color: #444; margin-bottom: 10px;">STAKE_FILTER</div>
                <select id="buyin-filter" onchange="applyFilters()" style="font-size: 18px; width: 100%;">
                    <option value="ALL">ALL_STAKES</option>
                    <option value="5">€ 5.00</option>
                    <option value="10">€ 10.00</option>
                    <option value="20">€ 20.00</option>
                </select>
            </div>
            <div id="import-log">In attesa di connessione...</div>
            <div class="graph-container"><canvas id="performanceChart"></canvas></div>
            <div class="card" style="grid-column: span 4;">
                <table>
                    <thead>
                        <tr><th>DATA</th><th>ROOM</th><th>MANI</th><th>PROFIT</th><th>VPIP</th><th>PFR</th><th>3BET</th></tr>
                    </thead>
                    <tbody id="session-list"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // TUO NUOVO URL AGGIORNATO
        const DB_URL = "https://script.google.com/macros/s/AKfycbxDT81UDInmuccMGw-T44N8r_apnBTOQxTGlj6rhAU8AbAVuD3T94Q6ECezyiFPYOUZwg/exec";
        let perfChart = null;
        let allData = [];

        function initDashboard() {
            initChart();
            loadDataFromDB();
            // Refresh automatico ogni 60 secondi
            setInterval(loadDataFromDB, 60000);
        }

        async function loadDataFromDB() {
            const user = "dr1v3r"; // Forzato come da tua richiesta
            const targetUrl = `${DB_URL}?action=getSessions&username=${encodeURIComponent(user)}`;
            
            document.getElementById('import-log').innerText = "SINCRONIZZAZIONE IN CORSO...";

            try {
                // Fetch con gestione redirect per Google Apps Script
                const response = await fetch(targetUrl);
                if (!response.ok) throw new Error("Network response was not ok");
                
                allData = await response.json();
                document.getElementById('import-log').innerText = "DATABASE CONNESSO - " + allData.length + " SESSIONI TROVATE";
                applyFilters();
            } catch (e) { 
                console.error("DB Error", e);
                document.getElementById('import-log').innerText = "ERRORE CONNESSIONE AL DATABASE";
            }
        }

        function initChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            perfChart = new Chart(ctx, {
                type: 'line',
                data: { labels: [0], datasets: [{ label: 'Net Profit', data: [0], borderColor: '#33c95c', borderWidth: 3, fill: true, backgroundColor: 'rgba(51, 201, 92, 0.1)', tension: 0.3 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { grid: { color: '#1a1a1a' } }, x: { display: false } } }
            });
        }

        function applyFilters() {
            const stake = document.getElementById('buyin-filter').value;
            const filtered = (stake === "ALL") ? allData : allData.filter(s => parseFloat(s.buyin) === parseFloat(stake));
            updateUI(filtered);
        }

        function updateUI(sessions) {
            let n = [0], total = 0, v = 0, pfr = 0;
            const tbody = document.getElementById('session-list');
            tbody.innerHTML = '';

            sessions.forEach(s => {
                let p = parseFloat(s.profit || 0);
                total += p;
                n.push(total);
                v += parseFloat(s.vpip || 0);
                pfr += parseFloat(s.pfr || 0);

                tbody.innerHTML += `<tr>
                    <td>${new Date(s.timestamp).toLocaleDateString()}</td>
                    <td>${s.room || 'iPoker'}</td>
                    <td>${s.hands || 0}</td>
                    <td style="color:${p>=0?'#33c95c':'#ff4444'}">€ ${p.toFixed(2)}</td>
                    <td style="color:var(--cyan)">${s.vpip || 0}%</td>
                    <td style="color:var(--orange)">${s.pfr || 0}%</td>
                    <td>${s.threebet || 0}%</td>
                </tr>`;
            });

            document.getElementById('total-profit').innerText = "€ " + total.toFixed(2);
            if(sessions.length > 0) {
                document.getElementById('avg-vpip').innerText = (v/sessions.length).toFixed(1) + "%";
                document.getElementById('avg-pfr').innerText = (pfr/sessions.length).toFixed(1) + "%";
            }
            
            perfChart.data.labels = Array.from(Array(n.length).keys());
            perfChart.data.datasets[0].data = n;
            perfChart.update();
        }

        function navigate(p) { window.location.href = p; }
        function logout() { localStorage.clear(); window.location.href = "index.html"; }
    </script>
</body>
</html>